rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // USER PROFILES
    // ========================================
    // Users can only read/write their own profile documents
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Allow users to read basic profile info of other users (for public profiles)
      allow read: if request.auth != null;
    }

    // ========================================
    // ARTWORKS & GALLERY
    // ========================================
    // Anyone can read published artworks
    match /artworks/{artworkId} {
      allow read: if true;
      
      // Only the artist (owner) can create/update/delete their artworks
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.artistId &&
        request.resource.data.artistId is string;
        
      allow update, delete: if request.auth != null && 
        request.auth.uid == resource.data.artistId;
    }

    // ========================================
    // PROJECTS
    // ========================================
    // Anyone can read active/published projects
    match /projects/{projectId} {
      allow read: if resource.data.status in ['active', 'published', 'recruiting'];
      
      // Only the project creator can create/update/delete their projects
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.createdBy &&
        request.resource.data.createdBy is string;
        
      allow update, delete: if request.auth != null && 
        request.auth.uid == resource.data.createdBy;
    }

    // ========================================
    // USER SAVED ITEMS
    // ========================================
    // Users can manage their own saved artworks
    match /savedArtworks/{savedId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
        
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId &&
        request.resource.data.userId is string;
    }

    // Users can manage their own saved projects
    match /savedProjects/{savedId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
        
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId &&
        request.resource.data.userId is string;
    }

    // ========================================
    // DAEVA AI CONVERSATIONS
    // ========================================
    // Users can only access their own AI conversations
    match /conversations/{conversationId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
        
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId &&
        request.resource.data.userId is string;
    }

    // ========================================
    // PROJECT APPLICATIONS & COLLABORATIONS
    // ========================================
    // Project applications - users can read their own applications
    match /projectApplications/{applicationId} {
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.applicantId || 
         request.auth.uid == resource.data.projectOwnerId);
         
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.applicantId &&
        request.resource.data.applicantId is string;
        
      allow update: if request.auth != null && 
        request.auth.uid == resource.data.projectOwnerId; // Only project owner can update status
    }

    // ========================================
    // NOTIFICATIONS
    // ========================================
    // Users can only read/update their own notifications
    match /notifications/{notificationId} {
      allow read, update: if request.auth != null && 
        request.auth.uid == resource.data.userId;
        
      // System can create notifications (handled server-side)
      allow create: if false; // Only server-side functions should create notifications
    }

    // ========================================
    // ADMIN FUNCTIONS
    // ========================================
    // Admin-only collections (for future admin panel)
    match /adminSettings/{document=**} {
      allow read, write: if request.auth != null && 
        request.auth.token.admin == true; // Custom claims for admin
    }

    match /reports/{document=**} {
      allow create: if request.auth != null; // Any user can create reports
      allow read, update: if request.auth != null && 
        request.auth.token.admin == true; // Only admins can read/update
    }

    // ========================================
    // ANALYTICS & METRICS (Optional)
    // ========================================
    match /analytics/{document=**} {
      allow read: if false; // Only server-side functions should access
      allow write: if false; // Only server-side functions should write
    }

    // ========================================
    // FALLBACK - DENY ALL OTHER ACCESS
    // ========================================
    // Explicitly deny access to any other documents
    match /{document=**} {
      allow read, write: if false;
    }
  }
}