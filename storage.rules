rules_version = '2';

service firebase.storage {

  // This matches your default GCS bucket
  match /b/{bucket}/o {

    // ========================================
    // HELPER FUNCTIONS
    // ========================================
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isValidImageFile() {
      return request.resource.contentType != null &&
             (request.resource.contentType.matches('image/.*') ||
              request.resource.contentType.matches('video/.*'));
    }

    function isValidDocumentFile() {
      return request.resource.contentType != null &&
             (request.resource.contentType.matches('application/pdf') ||
              request.resource.contentType.matches('text/.*') ||
              request.resource.contentType.matches('application/.*'));
    }

    function isUnderSizeLimit(maxSizeMB) {
      return request.resource.size < maxSizeMB * 1024 * 1024;
    }

    // ========================================
    // ARTESFERA PLATFORM COMPREHENSIVE RULES
    // ========================================

    // ===========================================
    // USER PROFILE & PRIVATE DATA
    // ===========================================

    // User's private, siloed data.
    // This path is for drafts, AI history, and temp files.
    // ALIGNS WITH FIRESTORE: /artesfera/users/{userId}
    match /artesfera/users/{userId}/{allPrivateFiles=**} {
      // Only owner can read/write their private files.
      // This covers:
      // - /artesfera/users/{userId}/profile/* (NEW UNIFIED PATH)
      // - /artesfera/users/{userId}/ai-history/*
      // - /artesfera/users/{userId}/temp/*
      allow read, write: if isOwner(userId) && isUnderSizeLimit(100);
    }

    // COMPATIBILITY: Current profile system (Legacy)
    match /profile-photos/{userId}/{allFiles=**} {
      allow read: if true; // Public read for legacy compatibility
      allow write: if isOwner(userId) && 
                    isValidImageFile() && 
                    isUnderSizeLimit(10);
    }

    // LEGACY: User folders structure (maintain compatibility)
    match /users/{userId}/images/{imageId} {
      allow read: if true; // Public read for legacy compatibility
      allow write: if isOwner(userId) && 
                    isValidImageFile() && 
                    isUnderSizeLimit(10);
    }

    match /users/{userId}/profile/{fileName} {
      allow read: if true; // Public read for legacy compatibility
      allow write: if isOwner(userId) && 
                    isValidImageFile() && 
                    isUnderSizeLimit(5);
    }

    // ===========================================
    // PUBLIC ASSETS (Artworks, Projects, Galleries)
    //
    // All public assets follow a "smart" rule:
    // They live in a public path, and their security
    // is governed by a corresponding Firestore document.
    // ===========================================

    // PORTFOLIO / ARTWORKS
    // ALIGNS WITH FIRESTORE: /artesfera/public/artworks/{artworkId}
    match /artesfera/public/artworks/{artworkId}/{allFiles=**} {
      allow read: if true; // Public access for gallery showcase
      // Write allowed IF user is the owner in Firestore
      allow write: if isAuthenticated() &&
                    isUnderSizeLimit(50) &&
                    firestore.get(
                      /databases/(default)/documents/artesfera/public/artworks/$(artworkId)
                    ).data.ownerId == request.auth.uid;
    }

    // PROJECT COLLABORATION
    // ALIGNS WITH FIRESTORE: /artesfera/public/projects/{projectId}
    match /artesfera/public/projects/{projectId}/{allFiles=**} {
      allow read: if true; // Public access for recruitment showcase
      // Write allowed IF user is owner OR a member in Firestore
      allow write: if isAuthenticated() && 
                    isUnderSizeLimit(100) && (
        firestore.get(
          /databases/(default)/documents/artesfera/public/projects/$(projectId)
        ).data.ownerId == request.auth.uid
        ||
        request.auth.uid in firestore.get(
          /databases/(default)/documents/artesfera/public/projects/$(projectId)
        ).data.members
      );
    }

    // GALLERY AND EXHIBITION SYSTEM
    // ALIGNS WITH FIRESTORE: /artesfera/public/galleries/{galleryId}
    match /artesfera/public/galleries/{galleryId}/{allFiles=**} {
      allow read: if isAuthenticated();
      // Write allowed IF user is the owner in Firestore
      allow write: if isAuthenticated() &&
                    isUnderSizeLimit(50) &&
                    firestore.get(
                      /databases/(default)/documents/artesfera/public/galleries/$(galleryId)
                    ).data.ownerId == request.auth.uid;
    }

    // ===========================================
    // PUBLIC COMMUNITY & AI ASSETS
    // (FIXED VULNERABILITY)
    // ===========================================

    // SHARED AI TEMPLATES
    // ALIGNS WITH FIRESTORE: /artesfera/public/ai-templates/{templateId}
    match /artesfera/public/ai-templates/{templateId}/{allFiles=**} {
      allow read: if isAuthenticated();
      // FIXED: Write allowed IF user is owner in Firestore
      allow write: if isAuthenticated() &&
                    isUnderSizeLimit(25) &&
                    firestore.get(
                      /databases/(default)/documents/artesfera/public/ai-templates/$(templateId)
                    ).data.ownerId == request.auth.uid;
    }

    // COMMUNITY SUBMISSIONS (e.g., for an Event)
    // ALIGNS WITH FIRESTORE: /artesfera/public/community-events/{eventId}/submissions/{submissionId}
    match /artesfera/public/community-events/{eventId}/submissions/{submissionId}/{allFiles=**} {
      allow read: if isAuthenticated();
      // FIXED: Write allowed IF user is owner of the submission doc
      allow write: if isAuthenticated() &&
                    isUnderSizeLimit(50) &&
                    firestore.get(
                      /databases/(default)/documents/artesfera/public/community-events/$(eventId)/submissions/$(submissionId)
                    ).data.ownerId == request.auth.uid;
    }

    // ===========================================
    // LEGACY/CURRENT COLLECTIONS (for compatibility)
    // ===========================================

    // Legacy projects support - Public access for recruitment showcase
    match /projects/{projectId}/files/{fileName} {
      allow read: if true; // Public access for recruitment showcase
      // Write access checks legacy /projects collection in Firestore
      allow write: if isAuthenticated() &&
                    isUnderSizeLimit(50) &&
                    firestore.get(
                      /databases/(default)/documents/projects/$(projectId)
                    ).data.ownerId == request.auth.uid;
    }

    // Legacy artworks support - Public access for gallery showcase
    match /artworks/{userId}/images/{imageId} {
      allow read: if true; // Public access for gallery showcase
      allow write: if isOwner(userId) && 
                    isValidImageFile() && 
                    isUnderSizeLimit(20);
    }

    // Current artwork images structure - includes temp folders for form uploads
    match /artwork-images/{userId}/{artworkId}/{imageId} {
      allow read: if true; // Public access for gallery showcase
      allow write: if isOwner(userId) && 
                    isValidImageFile() && 
                    isUnderSizeLimit(20);
    }

    // Temporary uploads folder (auto-delete after 24 hours)
    match /temp/{userId}/{fileName} {
      allow read, write: if isOwner(userId) && isUnderSizeLimit(100);
    }

    // Platform assets (logos, banners, system images)
    match /artesfera/system/assets/{allFiles=**} {
      allow read: if true;
      allow write: if false; // Managed by admin only
    }

    // ========================================
    // FALLBACK - DENY ALL
    // ========================================
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}